<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>CORDE | ì½”ë”” ë£©ë¶</title>
  <link rel="stylesheet" href="result.css" />
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
  
  <!-- html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>

<body>
  <!-- HEADER -->
  <header>
    <img src="images/main_header_rectangle.svg" class="nav-bg" />
    <a href="home.html">
      <img src="images/corde_logo.svg" class="logo" />
    </a>
    <a href="usage.html" class="nav-text nav-about">About</a>
    <a href="howitworks.html" class="nav-text nav-how">How it works</a>
    <a href="persona.html" class="nav-text nav-persona">Persona</a>
  </header>

  <h1 class="title">ì½”ë”” ë£©ë¶</h1>

  <!-- BOOK WRAPPER -->
  <div class="book-wrapper">
    <!-- ì´ì „ ë²„íŠ¼ -->
    <button class="nav-btn prev" onclick="prevPage()"></button>

    <!-- í˜ì´ì§€ ì»¨í…Œì´ë„ˆ (JavaScriptë¡œ ë™ì  ìƒì„±) -->
    <div class="page-container" id="pageContainer">
      <!-- JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë‹¤ìŒ ë²„íŠ¼ -->
    <button class="nav-btn next" onclick="nextPage()"></button>
  </div>

    <!-- QR ì½”ë“œ ì„¹ì…˜ -->
    <div class="footer">
      <button class="qr-btn" onclick="generateQRCode()">
        ğŸ“± QR ì½”ë“œ ìƒì„±í•˜ê¸°
      </button>
    </div>

    <!-- QR ì½”ë“œ í‘œì‹œ ì˜ì—­ -->
    <div id="qrSection" class="qr-section" style="display:none;">
      <h3>ğŸ“± ëª¨ë°”ì¼ë¡œ ìŠ¤ìº”í•˜ì„¸ìš”</h3>
      <p class="qr-description">ê°™ì€ Wi-Fië¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ìŠ¤ìº”í•˜ë©´ ë£©ë¶ì„ ë³¼ ìˆ˜ ìˆì–´ìš”</p>
      <div id="qrCodeContainer" class="qr-container">
        <img id="qrCodeImage" src="" alt="QR Code" />
      </div>
    </div>

  <script>
    // ====================================
    // ì „ì—­ ë³€ìˆ˜
    // ====================================
    let currentPage = 0;
    let totalPages = 0;
    let currentPersona = null;

    // ê¸°ë³¸ ì´ë¯¸ì§€ (SVG Data URI)
    const DEFAULT_IMAGE = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="300" height="300"%3E%3Crect fill="%23f5f5f5" width="300" height="300"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="16" fill="%23999"%3Eì´ë¯¸ì§€ ì—†ìŒ%3C/text%3E%3C/svg%3E';

    // TPO ë¼ë²¨ ë§¤í•‘
    const TPO_LABELS = {
      'pme': 'ì¹œêµ¬ ìƒì¼ì„ ìœ„í•œ ì½”ë””ë¶',
      'nowon': 'í¸ì•ˆí•œ ì¼ìƒ ì½”ë””ë¶',
      'ob': 'í™œë™ì ì¸ ë°ì´íŠ¸ ì½”ë””ë¶',
      'promi': 'ë¡œë§¨í‹±í•œ ì €ë… ì½”ë””ë¶',
      'moyon': 'ì„¸ë ¨ëœ ëª¨ì„ ì½”ë””ë¶',
      'seoksa': 'ì§€ì ì¸ ìº í¼ìŠ¤ ì½”ë””ë¶'
    };

    // ì¹´í…Œê³ ë¦¬ ìˆœì„œ
    const CATEGORY_ORDER = ['ìƒì˜', 'ì•„ìš°í„°', 'ë°”ì§€', 'ì‹ ë°œ', 'ê°€ë°©'];

    // ====================================
    // ì´ˆê¸°í™”
    // ====================================
    function initialize() {
      // URLì—ì„œ persona ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      currentPersona = params.get('persona');

      if (!currentPersona) {
        alert('í˜ë¥´ì†Œë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        window.location.href = 'persona.html';
        return;
      }

      // persona í´ë˜ìŠ¤ ì ìš©
      document.body.classList.add(`persona-${currentPersona}`);

      // localStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const storedData = localStorage.getItem('finalOutfit');

      if (!storedData) {
        alert('ì½”ë”” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
        window.location.href = 'home.html';
        return;
      }

      const data = JSON.parse(storedData);

      // í˜ì´ì§€ ë Œë”ë§
      renderPages(data);

      // ì´ˆê¸° í˜ì´ì§€ í‘œì‹œ
      updatePage();
    }

    // ====================================
    // í˜ì´ì§€ ë Œë”ë§
    // ====================================
    function renderPages(data) {
      const container = document.getElementById('pageContainer');
      container.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì œê±°

      let pageIndex = 0;

      // 0. ì»¤ë²„ í˜ì´ì§€ (refined_tpo í¬í•¨)
      const refinedTPO = data.refined_tpo || data.tpo || 'ì˜¤ëŠ˜ì˜ ìŠ¤íƒ€ì¼ì„ ìœ„í•œ ì¶”ì²œ';
      
      container.innerHTML += `
        <div class="page cover active" data-page="${pageIndex}">
          <div class="cover-label">${escapeHtml(refinedTPO)}</div>
        </div>
      `;
      pageIndex++;

      // 1-5. ì•„ì´í…œ í˜ì´ì§€ë“¤ (ì¹´í…Œê³ ë¦¬ ìˆœì„œëŒ€ë¡œ)
      CATEGORY_ORDER.forEach(category => {
        const item = data.selected_items[category];
        
        if (item) {
          // const imgUrl = item.img_url || DEFAULT_IMAGE;
          const imgUrl = item.img_url
            ? `http://127.0.0.1:8000/image-proxy?url=${encodeURIComponent(item.img_url)}`
            : DEFAULT_IMAGE;

          const productName = item.product_name || 'ìƒí’ˆëª… ì—†ìŒ';
          const brand = item.brand || 'ë¸Œëœë“œ ì •ë³´ ì—†ìŒ';
          const price = item.price || 'ê°€ê²© ì •ë³´ ì—†ìŒ';
          const itemUrl = item.item_url || '#';

          container.innerHTML += `
            <div class="page item" data-page="${pageIndex}">
              <img src="${imgUrl}" 
                   alt="${escapeHtml(productName)}"
                   onerror="this.src='${DEFAULT_IMAGE}'" />
              <div class="brand">${escapeHtml(brand)}</div>
              <div class="name">${escapeHtml(productName)}</div>
              <div class="price">${escapeHtml(price)}</div>
              <a class="link" href="${itemUrl}" target="_blank">ìƒí’ˆ ë³´ëŸ¬ê°€ê¸° â†’</a>
            </div>
          `;
          pageIndex++;
        }
      });

      totalPages = pageIndex - 1; // ë§ˆì§€ë§‰ í˜ì´ì§€ ì¸ë±ìŠ¤
    }

    // ====================================
    // HTML ì´ìŠ¤ì¼€ì´í”„
    // ====================================
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ====================================
    // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
    // ====================================
    function updatePage() {
      // ëª¨ë“  í˜ì´ì§€ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });

      // í˜„ì¬ í˜ì´ì§€ë§Œ ë³´ì´ê¸°
      const activePage = document.querySelector(`[data-page="${currentPage}"]`);
      if (activePage) {
        activePage.classList.add('active');
      }

      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
      const prevBtn = document.querySelector('.nav-btn.prev');
      const nextBtn = document.querySelector('.nav-btn.next');

      prevBtn.style.visibility = currentPage === 0 ? 'hidden' : 'visible';
      nextBtn.style.visibility = currentPage === totalPages ? 'hidden' : 'visible';
    }

    function nextPage() {
      if (currentPage < totalPages) {
        currentPage++;
        updatePage();
      }
    }

    function prevPage() {
      if (currentPage > 0) {
        currentPage--;
        updatePage();
      }
    }

    // ====================================
    // ğŸ†• QR ì½”ë“œ ìƒì„±
    // ====================================
    async function generateQRCode() {
      try {
        const submitBtn = document.querySelector('.qr-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'QR ì½”ë“œ ìƒì„± ì¤‘...';

        // 1. localStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const outfitData = JSON.parse(localStorage.getItem('finalOutfit'));
        
        if (!outfitData) {
          alert('ë£©ë¶ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
          return;
        }

        // 2. API í˜¸ì¶œ - QR ì½”ë“œ ìƒì„±
        const response = await fetch('http://127.0.0.1:8000/generate_qr', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            outfit_data: outfitData,
            persona: currentPersona
          })
        });

        if (!response.ok) {
          throw new Error('QR ì½”ë“œ ìƒì„± ì‹¤íŒ¨');
        }

        const result = await response.json();
        
        // 3. QR ì½”ë“œ í•˜ë‹¨ ì„¹ì…˜ì— í‘œì‹œ
        document.getElementById('qrCodeImage').src = result.qr_code_url;
        document.getElementById('qrSection').style.display = 'block';
        
        // 4. QR ì½”ë“œ URL ì €ì¥
        window.lookbookUrl = result.lookbook_url;
        
        console.log('âœ… QR ì½”ë“œ ìƒì„± ì™„ë£Œ!');
        console.log('   ë£©ë¶ URL:', result.lookbook_url);
        
      } catch (error) {
        console.error('QR ì½”ë“œ ìƒì„± ì˜¤ë¥˜:', error);
        alert('QR ì½”ë“œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      } finally {
        const submitBtn = document.querySelector('.qr-btn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“± QR ì½”ë“œ ìƒì„±í•˜ê¸°';
      }
    }


    // ====================================
    // ğŸ”„ ì´ˆê¸°í™” í•¨ìˆ˜ (PC ì „ìš©)
    // ====================================
    async function initialize() {
      // URLì—ì„œ persona ê°€ì ¸ì˜¤ê¸°
      const params = new URLSearchParams(window.location.search);
      currentPersona = params.get('persona');

      if (!currentPersona) {
        alert('í˜ë¥´ì†Œë‚˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
        window.location.href = 'persona.html';
        return;
      }

      // persona í´ë˜ìŠ¤ ì ìš©
      document.body.classList.add(`persona-${currentPersona}`);

      // localStorageì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
      const storedData = localStorage.getItem('finalOutfit');

      if (!storedData) {
        alert('ì½”ë”” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
        window.location.href = 'home.html';
        return;
      }

      const data = JSON.parse(storedData);

      // í˜ì´ì§€ ë Œë”ë§
      renderPages(data);

      // ì´ˆê¸° í˜ì´ì§€ í‘œì‹œ
      updatePage();
    }

    // ====================================
    // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
    // ====================================
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        prevPage();
      } else if (e.key === 'ArrowRight') {
        nextPage();
      }
    });

    // ====================================
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    // ====================================
    window.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>